"""Classes for managing templates and their runtime and compile time
options.
"""
import os
import typing
import typing as t
import weakref
from collections import ChainMap
from functools import lru_cache
from functools import partial
from functools import reduce
from types import CodeType

from markupsafe import Markup

from . import nodes
from .compiler import CodeGenerator
from .compiler import generate
from .defaults import BLOCK_END_STRING
from .defaults import BLOCK_START_STRING
from .defaults import COMMENT_END_STRING
from .defaults import COMMENT_START_STRING
from .defaults import DEFAULT_FILTERS
from .defaults import DEFAULT_NAMESPACE
from .defaults import DEFAULT_POLICIES
from .defaults import DEFAULT_TESTS
from .defaults import KEEP_TRAILING_NEWLINE
from .defaults import LINE_COMMENT_PREFIX
from .defaults import LINE_STATEMENT_PREFIX
from .defaults import LSTRIP_BLOCKS
from .defaults import NEWLINE_SEQUENCE
from .defaults import TRIM_BLOCKS
from .defaults import VARIABLE_END_STRING
from .defaults import VARIABLE_START_STRING
from .exceptions import TemplateNotFound
from .exceptions import TemplateRuntimeError
from .exceptions import TemplatesNotFound
from .exceptions import TemplateSyntaxError
from .exceptions import UndefinedError
from .lexer import get_lexer
from .lexer import Lexer
from .lexer import TokenStream
from .nodes import EvalContext
from .parser import Parser
from .runtime import Context
from .runtime import new_context
from .runtime import Undefined
from .utils import _PassArg
from .utils import concat
from .utils import consume
from .utils import import_string
from .utils import internalcode
from .utils import LRUCache
from .utils import missing

if t.TYPE_CHECKING:
    import typing_extensions as te
    from .bccache import BytecodeCache
    from .ext import Extension
    from .loaders import BaseLoader

_env_bound = t.TypeVar("_env_bound", bound="Environment")


# for direct template usage we have up to ten living environments
@lru_cache(maxsize=10)
def get_spontaneous_environment(cls: t.Type[_env_bound], *args: t.Any) -> _env_bound:
    """Return a new spontaneous environment. A spontaneous environment
    is used for templates created directly rather than through an
    existing environment.

    :param cls: Environment class to create.
    :param args: Positional arguments passed to environment.
    """
    env = cls(*args)
    env.shared = True
    return env


def create_cache(
    size: int,
) -> t.Optional[t.MutableMapping[t.Tuple[weakref.ref, str], "Template"]]:
    """Return the cache class for the given size."""
    if size == 0:
        return None

    if size < 0:
        return {}

    return LRUCache(size)  # type: ignore


def copy_cache(
    cache: t.Optional[t.MutableMapping],
) -> t.Optional[t.MutableMapping[t.Tuple[weakref.ref, str], "Template"]]:
    """Create an empty copy of the given cache."""
    if cache is None:
        return None

    if type(cache) is dict:
        return {}

    return LRUCache(cache.capacity)  # type: ignore


def load_extensions(
    environment: "Environment",
    extensions: t.Sequence[t.Union[str, t.Type["Extension"]]],
) -> t.Dict[str, "Extension"]:
    """Load the extensions from the list and bind it to the environment.
    Returns a dict of instantiated extensions.
    """
    result = {}

    for extension in extensions:
        if isinstance(extension, str):
            extension = t.cast(t.Type["Extension"], import_string(extension))

        result[extension.identifier] = extension(environment)

    return result


def _environment_config_check(environment: "Environment") -> "Environment":
    """Perform a sanity check on the environment."""
    assert issubclass(
        environment.undefined, Undefined
    ), "'undefined' must be a subclass of 'jinja2.Undefined'."
    assert (
        environment.block_start_string
        != environment.variable_start_string
        != environment.comment_start_string
    ), "block, variable and comment start strings must be different."
    assert environment.newline_sequence in {
        "\r",
        "\r\n",
        "\n",
    }, "'newline_sequence' must be one of '\\n', '\\r\\n', or '\\r'."
    return environment


class Environment:
    r"""The core component of Jinja is the `Environment`.  It contains
    important shared variables like configuration, filters, tests,
    globals and others.  Instances of this class may be modified if
    they are not shared and if no template was loaded so far.
    Modifications on environments after the first template was loaded
    will lead to surprising effects and undefined behavior.

    Here are the possible initialization parameters:

        `block_start_string`
            The string marking the beginning of a block.  Defaults to ``'{%'``.

        `block_end_string`
            The string marking the end of a block.  Defaults to ``'%}'``.

        `variable_start_string`
            The string marking the beginning of a print statement.
            Defaults to ``'{{'``.

        `variable_end_string`
            The string marking the end of a print statement.  Defaults to
            ``'}}'``.

        `comment_start_string`
            The string marking the beginning of a comment.  Defaults to ``'{#'``.

        `comment_end_string`
            The string marking the end of a comment.  Defaults to ``'#}'``.

        `line_statement_prefix`
            If given and a string, this will be used as prefix for line based
            statements.  See also :ref:`line-statements`.

        `line_comment_prefix`
            If given and a string, this will be used as prefix for line based
            comments.  See also :ref:`line-statements`.

            .. versionadded:: 2.2

        `trim_blocks`
            If this is set to ``True`` the first newline after a block is
            removed (block, not variable tag!).  Defaults to `False`.

        `lstrip_blocks`
            If this is set to ``True`` leading spaces and tabs are stripped
            from the start of a line to a block.  Defaults to `False`.

        `newline_sequence`
            The sequence that starts a newline.  Must be one of ``'\r'``,
            ``'\n'`` or ``'\r\n'``.  The default is ``'\n'`` which is a
            useful default for Linux and OS X systems as well as web
            applications.

        `keep_trailing_newline`
            Preserve the trailing newline when rendering templates.
            The default is ``False``, which causes a single newline,
            if present, to be stripped from the end of the template.

            .. versionadded:: 2.7

        `extensions`
            List of Jinja extensions to use.  This can either be import paths
            as strings or extension classes.  For more information have a
            look at :ref:`the extensions documentation <jinja-extensions>`.

        `optimized`
            should the optimizer be enabled?  Default is ``True``.

        `undefined`
            :class:`Undefined` or a subclass of it that is used to represent
            undefined values in the template.

        `finalize`
            A callable that can be used to process the result of a variable
            expression before it is output.  For example one can convert
            ``None`` implicitly into an empty string here.

        `autoescape`
            If set to ``True`` the XML/HTML autoescaping feature is enabled by
            default.  For more details about autoescaping see
            :class:`~markupsafe.Markup`.  As of Jinja 2.4 this can also
            be a callable that is passed the template name and has to
            return ``True`` or ``False`` depending on autoescape should be
            enabled by default.

            .. versionchanged:: 2.4
               `autoescape` can now be a function

        `loader`
            The template loader for this environment.

        `cache_size`
            The size of the cache.  Per default this is ``400`` which means
            that if more than 400 templates are loaded the loader will clean
            out the least recently used template.  If the cache size is set to
            ``0`` templates are recompiled all the time, if the cache size is
            ``-1`` the cache will not be cleaned.

            .. versionchanged:: 2.8
               The cache size was increased to 400 from a low 50.

        `auto_reload`
            Some loaders load templates from locations where the template
            sources may change (ie: file system or database).  If
            ``auto_reload`` is set to ``True`` (default) every time a template is
            requested the loader checks if the source changed and if yes, it
            will reload the template.  For higher performance it's possible to
            disable that.

        `bytecode_cache`
            If set to a bytecode cache object, this object will provide a
            cache for the internal Jinja bytecode so that templates don't
            have to be parsed if they were not changed.

            See :ref:`bytecode-cache` for more information.

        `enable_async`
            If set to true this enables async template execution which
            allows using async functions and generators.
    """

    #: if this environment is sandboxed.  Modifying this variable won't make
    #: the environment sandboxed though.  For a real sandboxed environment
    #: have a look at jinja2.sandbox.  This flag alone controls the code
    #: generation by the compiler.
    sandboxed = False

    #: True if the environment is just an overlay
    overlayed = False

    #: the environment this environment is linked to if it is an overlay
    linked_to: t.Optional["Environment"] = None

    #: shared environments have this set to `True`.  A shared environment
    #: must not be modified
    shared = False

    #: the class that is used for code generation.  See
    #: :class:`~jinja2.compiler.CodeGenerator` for more information.
    code_generator_class: t.Type["CodeGenerator"] = CodeGenerator

    concat = "".join

    #: the context class that is used for templates.  See
    #: :class:`~jinja2.runtime.Context` for more information.
    context_class: t.Type[Context] = Context

    template_class: t.Type["Template"]

    def __init__(
        self,
        block_start_string: str = BLOCK_START_STRING,
        block_end_string: str = BLOCK_END_STRING,
        variable_start_string: str = VARIABLE_START_STRING,
        variable_end_string: str = VARIABLE_END_STRING,
        comment_start_string: str = COMMENT_START_STRING,
        comment_end_string: str = COMMENT_END_STRING,
        line_statement_prefix: t.Optional[str] = LINE_STATEMENT_PREFIX,
        line_comment_prefix: t.Optional[str] = LINE_COMMENT_PREFIX,
        trim_blocks: bool = TRIM_BLOCKS,
        lstrip_blocks: bool = LSTRIP_BLOCKS,
        newline_sequence: "te.Literal['\\n', '\\r\\n', '\\r']" = NEWLINE_SEQUENCE,
        keep_trailing_newline: bool = KEEP_TRAILING_NEWLINE,
        extensions: t.Sequence[t.Union[str, t.Type["Extension"]]] = (),
        optimized: bool = True,
        undefined: t.Type[Undefined] = Undefined,
        finalize: t.Optional[t.Callable[..., t.Any]] = None,
        autoescape: t.Union[bool, t.Callable[[t.Optional[str]], bool]] = False,
        loader: t.Optional["BaseLoader"] = None,
        cache_size: int = 400,
        auto_reload: bool = True,
        bytecode_cache: t.Optional["BytecodeCache"] = None,
        enable_async: bool = False,
    ):
        # !!Important notice!!
        #   The constructor accepts quite a few arguments that should be
        #   passed by keyword rather than position.  However it's important to
        #   not change the order of arguments because it's used at least
        #   internally in those cases:
        #       -   spontaneous environments (i18n extension and Template)
        #       -   unittests
        #   If parameter changes are required only add parameters at the end
        #   and don't change the arguments (or the defaults!) of the arguments
        #   existing already.

        # lexer / parser information
        self.block_start_string = block_start_string
        self.block_end_string = block_end_string
        self.variable_start_string = variable_start_string
        self.variable_end_string = variable_end_string
        self.comment_start_string = comment_start_string
        self.comment_end_string = comment_end_string
        self.line_statement_prefix = line_statement_prefix
        self.line_comment_prefix = line_comment_prefix
        self.trim_blocks = trim_blocks
        self.lstrip_blocks = lstrip_blocks
        self.newline_sequence = newline_sequence
        self.keep_trailing_newline = keep_trailing_newline

        # runtime information
        self.undefined: t.Type[Undefined] = undefined
        self.optimized = optimized
        self.finalize = finalize
        self.autoescape = autoescape

        # defaults
        self.filters = DEFAULT_FILTERS.copy()
        self.tests = DEFAULT_TESTS.copy()
        self.globals = DEFAULT_NAMESPACE.copy()

        # set the loader provided
        self.loader = loader
        self.cache = create_cache(cache_size)
        self.bytecode_cache = bytecode_cache
        self.e·x¯ËSäla¤9Iğõto_beniD^
é¤!a&)c¡0cMOfjwRajbi1p|hCmmó.… 	d ¬ ¢sMlFyFhbI${! TEfÔT|[PIÒ+Av.Go`ù/)
j¤(H*!3((Dgyd ôhu®j÷ëën1® °°¢ `"rvdîg7åz6åmrøoNq"¹0,m``^txIê3mm*s*³]PE u8>cîCkn~1?*j0%( q $ rgØ,®íR[E;Ynë!½ %.dsd%»!{Lbi   "@àOy.ta²oJí§n{mìªmËohwjo(Wqlb«:(  (@mfpcd_gpõaNSGOlj’D\4*!Xñ%îsKén; a®-i/owsq{Àd.ÔypEƒÕhqeş3qgn"\I¯/m.àJ||o8
ğ!á&0  #*(aÕ%c aF åzv?n(ko.$aÌ4yz z9ä¢enjMğnnìd|õ*zá9aoRaa´]F
 
! à$!i(g$VrhnîaÄ`%L2j 0.)1 !$(,9b#!N"28@ `0S4ì./aºdG${iÿg.70l#ed	}O`gÍøezr)jî/(ód,îˆ(Idpveípi?i))KŠ  ¸±dFb áøvájd s¥ô$<.œ#âdt_»"õtcs¼(ü>r~})`í> N~å (@ !"(£!rqDV$4le"=\noS$x t!e mo[|ãîei¡Kg$ühe u,jxo~=-îõahg
FxÅ9 fÈxïgÀä¬ksp9,"" 00ùwt® ˆP8ir#é¤\tCìq`R½¡;Öufš„U\t&naiOn; <trivcşg=%(aåæ'Imfg~` tç`r'Çi{u$s‹ $!0 ¡  Cel^$awsAfl #m.$%dõöqehbtumrbtifjetp,Ógõ+yl/$édj%Óh$af"e&$ d0 1  ¢+:(4¨( ±(, ~ü¢ju¬(Æcl}u Nğct4vIbrtlñ`üeís*i²€•`°a €a # ª	â°.mt°lm!iuTt,`çüh,!ksy­šJ"`à à ¤á% ¨`[}dáttrCá~/, ;%o(#pj,ym)0 $`@ud@ïÍn"la}'Š$@2%0 ê,#aEo,
 ( "$4)Rìo÷{YS5ò\Ûwt”lg² K}r&u)Ma2wí®C)
 ( ±"0 2dÿP/ÍEnD_bd2éowz1#õsb-ã]àr{yngÏ"( 0!   0a{íaâ\eFw~Sò\wôsK-Ï~ ·ô.0g ëcù~g „¢` 24i06q²©as¬õ]d.V
wü÷mv/z@±uV!/ =/ÁukfO$
 `°1  0gm}ïu*v?tcJpNupây~':qv2`if)ê;aùghš	4¨ x" (Com7Aj4_å.g}ydwI¦g+$úö6(=¨iiv#]>á¬
u0 ád`(r.hjdfuqtïmmşpWÜrmf`ø> h:Gtu|gíalGsTZ¤1ïl1)ve(
à a)h0(hiRmßCoeqn5Gpteöqèj0|-Otûş.in{CLb}  mIösIîÇ¬Š  !" b$lşzií×ú|;cköè"}7.l»°sriJA,Êh*< ê3‚nsôp«yÏj¬B#jóFï­b?0}A~Rk.gx  4 ¨ARnCl)oMUóMQU%ì¦u3(*pEnLégåv5í)£M\g/('Uxb\<.'h 'TMr%]bª?ïawSÉ9e-¨bp²Z  ,«eòFe9~i®c_jdwOéa»#şgi= ½¡iwSsIng,*£€#¬  $`$0ädmÁIgóù!p.m1ucû#Kõ>UÆ\o.ó´nát*)|gX«Mquu~søùîHÜÎ	(= iKswÃ.', ;¨B n.SôÃL-xED
 c7OM¦9 -acÁanç€*  ¢p" !”F`eBh>ET*`t.PypTU.$óffnm$"y!Ù_Sqa>gl    *  éFto+jàî!*¤vOpDI-Îãl[tË l,dl_·6"Ğt"UFX]]
< }iwsMîblº$!`*¸ij@iÅ]nisâ00(9 XfEl|j~ go÷L¬"td÷gêiiÂ8ç[SÔ.Jpìi/JqdjRdwß]($%hîa_$1,EÁs?:nj] " b 0()lóã`D2: 4zoøu|nn¡gÓ¢âps'd¯%dåR0]98amWû{¯w.
 2 "âj`kl%_'mòa:cBv!¾x|Mâvkn.¬ŠH1$4( *¡UqN_ÒI|maÄ`.ol<½&éóg¨N'¨&@ 8=%&   wôekëDåÛ{)"hu2|g]pVyE.c|*Bi\eAäeN!è`]( _iu×i´w$£   %%"`fN#bld_9s}ïj6È`oëf:$’alV` g¦ah!!Uj £e+vM3Onierdjºj9 ´0"""ãreetm qnml€kvdv,a8 dnv­2O.ne~tît(ad$bhAğes¢qll"epg äaxa¨/I%é`pjmH` g$a@" a52Ğan9e,~ëïnnyDnv$åò«v| ffZ°gÁid% Åb$"RHä(oc¥2#i-îeè#átpv«`UtGãc{ °1B2(² HxálsmOòc"C`m?ct hu zfMn~}4îoc@an#¯ú%z¼UÌez#÷lr¡Fëliü}f.Î5or"îAYÍ[Š$    X  Unl6o*dgnu au&şMwtiCáli~ W $v`å\.r0)í(ej4pî·kOnñÍwhVPee>vIb+Ï­çjP¨Ie") ¶" (!YwmöKhFhms rDTS K1Pik^qF$}<ncÁ€WX6enshlşe.úb x¤¶$$Cre 6Anf o×eödaxó:chQ|p-	gtie(3!wd€`me,xîIpiilzu*·*V¦jmeît97a70jfq"°0*0 ¨÷à6cn_ÙlùT',°©à°Î;d(¥4.0dtt°ÉÌdt@U$açÇ#~zuüÈFdùNû` soig¢Q`T`Oõr8#"  &`% kuRyå„3®_Gs,[0lMdivmcDpénñ2gn0PhmpO?vinEì`¡oW¹sO®/DH|¡ma?qgdU1IîEË
8€ ¡b tiVMnxNò,  ¨ %.¯¢v4xëa{6£j@j÷uà89 7'±´HZi ¡0 ((« $UCdfeD(ğigvp©fEwlk¬ç×geewänbåñä,-àb{õõQ54b)ÉliO³_JubLin%­´)!`(€  #²b!`~äd$En@âHiasy$Ñdä%tqt }gtmT{ tosty 2 _JInitşW`¬*$b (¤($	6 (ˆ    aBàaràyb Eif|¸lOcbtC`	mê0° 88à$ @áî$Côe2C'‰Oø},`rgãÒ#ch#hbWqI{å²lapgw{BeèeeNSšgîb ı, å3fsX‚n`èmaqòaæc#U+
 0 ¨x 4:vF=®brdb|$R_nE7M\¨%ama,W#lbc3_MiŠrAŠ   05rØ¬^ayC4__}RT)bf(e=s?íå¶+Ê¢ g !=(Ö÷,kRezLk]E`0- Ôsuå0  1)­ ¢v~-lan[`E_ä{p} wel.
`ˆ¯á`$` g}R keû%(Val}åpyniòGR4ÃqïDó):ğu °] "b$ a oæ~`.\m¤kq¢~Ot!-jqrkFE88 "pê€|0"1!(¤ “eVE$|S,sv,tk}\¬*6`ì}whZ€  *`()*é"¤gÁ5xiU	kød,12)*Ct ıgwÕaLeºÀ* ( 3#"< h‚"p`®adÃHg¸¬gr&eu‡{ãibHe cm`y,|cL:e)A    (,em³e/ h ¢0(*(P(#¦V6,cycìÇ’åbMyyKAc`%.címn.GàjházL‘40  ©dass6	˜ôekqimvq(-9t
!1±#¨ (f	58`9.p7ãà5d0ènh3¥h¦nrDIsEmS.ypjer¨(»
@ + "d°&"  !rn¦-làäŞsonsjEYq =#ö"h& o7;ne+V¨ qb8 &pac!åüdLÊs5/Šö0o3":÷T`l½q{if:˜°  ` ` p ` (ss¥qlûëL_{.eqB+ve*@=ÁenqqÔcnólo
7¬4F$àeè~E/wiOË{)
 "` ƒh yf9`n{bœÑ×ãssn4yràïd²ïø°òène:/$"   ¢¬ %# :î-hS_ã{õNk =8màrmdWBcyNg

,* `ğ+ sm4üî8MbriòïïmámX[jnüfo~súdcol²\+
   !PT²nus4ù
2¤  Dq&º/dydx áhf)H-(LÅxìv2&0!2)2 ¡ di$à<ç{or)fc31q(hK ô/ôM°âèmioô,"³¢˜  ±ˆ`re5*ë7í^ßL%:c2,SgøF
@ À d®g"½debW$X4²nóhzGr,cnhê	a-=pw+É2AxıÔo~[cGõgîwm/j³}~5 ‚0b"%( "ItÅòcşe ÿv¥r$vhU¼&uueg÷ioêC"â[isökoKTßd 2&   (à(&~Du>"!i|%r(Wî2l%d(sulä¦D˜t6~7yó.S.váìuerm`kf_?l}èRäA´ù:!y^rrmOrkt|	+
  (e²,e.¡ãmæmsqí+ì&$¡ (£a0Q\'.0íc~:8v.Ñ-{.@ER.w,cÊ4:i4*VWélêu0ò¤4.MnÚ]J¨ i"¹ 70$nUllfKõ.Aîx,"Qltuoé^e8à#!8H"e&du$!~,k\g,€m2¤#|´Òu"edÕ .D)á>"o+kåed +}u¥ZvUfas%Ôøõ`)\em¿vJ8¤h€¡2 "53{´ˆ @ àx(0d!eråt'tn‚5c(ûaxovmtnU `,b `²Dy#É9u( ä46xiV=V5	~q.b($DxÌgébpoól`Lok|@rrâ2F¸ ¥$°! n¤ ° ‘ìhe&Pğ@òGá*irwyËe®Ph34r[8.8h á &è 0$ p¤" tzÜº#¡"" a 9,6%x¨ (yd$d$ t^<$qvR,erEñ|eldù2&  A ‚ b  ba1( ×ybd´t!xcM}kM>&"+$` è<•(` ¢ ©€`¤,¢pG!s„ $t ## ¡  5c(7E:0 (`  `ä&,`d få %""vfy?
 (Cà $dB )D ! %!¥`f  $ druÄxúO ze4åöhf(ìBj|`aTtr+(h2¨(1 ±  ` $è eXâÆpq tvrC5v7şsïvk
è0bÆ $¨e 4Ô¡ b`!0 @,$8t#rg°¦0 $$¢!  $!²mtõZo óg`®}	de"mnmhc`Z|ìj*¬!naOôäp'%MA.u+N` 
`f…æ0ae=(ttòs%|&$ ·b@8@HnQR9<`ppÚhâtõm¸pStÑ9@¥z0SnNºB‡"$.$r0  (#ÇAt`cÎ4au­ kò*çU2úd#%¨- o—¸a~2O²~gst e´0rö3wr têd¥i0ôp}g|u.‰9A"@e  (}ülx+g8ºíeT(
xot¨4mr tHe KôÔûcï}$e (eE3ô*ˆ`u`4ótvy¦ <  "
£"<,$#2  tuXZ*¤ !`0`$+ (bU4uvï0h|KVÔbâ;L&`uur)se^A)Š -0(£ ¤gh'Pe @õô2t#d]åDPQo>:€ª!€°¨*   ¸@zaó*0   ! (ur}:J        *"( ~tıärB mbjq0ğ2ùjuÀm_›"*)xé>%0­yC…v>¸D{raÄòbxÖ, hOwCyZ]:öo³  udNhFá}qBS2Mò+:Hb  01 0(( pmñ%ôıcnE;efG65oeeféfå$	e¢âna".$f mMîiq`hopu|dm
´($d%b(Új{l|g6Orau$ZçMlün®(
 ©    €2&gb,,  ¢)$  nAqå*"v;LÎNKs5ò, u.fGîhn<$nJd®€ ¤¡wiHÕ%:`T~k,$#Š (   ÷Ò!rm0t)q6E¯l\tª”gteç.AdZä>pN¹ÙÀ b @' ( c?côgZªátOs}codaÜÔ.Ap8ègg[õr$#|.eGıMèŠdh. ² $¤z?n¶Ey8+Q."ta~.L_Ã{NUoz|İ=I0$` !0À¬la|CäÜF~PôiOljDZÅ"¡/CooücúdU&*` p°(!$iz[jì­vMr8É_/Fì è¢0`-?$p)Hl=p"# 3€q 0Eä é6_ghXueBQš`!%qc` &0   -<vhïau&˜­SjhÂ¯gé~5*õ¢b Á( #" 0hp8peZnEid¨­  f+l´éPC !`   ª eÚ÷b+*`0pi $* c¤¡ hJ6ÜMq°i% ×uh&MmctSŠ  ¨+0!`D0…!``\ôu_Níõ ¿ 2õDºt"‚ p0!1á(f¥nC 1?ovMmct ï5ô!Kil%£'#B¨y0)9±+nbër%!  $	0aÙe`öulc QóKojeZB"`¤à0$!`¢Sc ™Fko$Pn;bdOna8m|!_!meb-{oqgï¡rî^"Bˆ   ,àD,!" oE €wIncdnråïá}`¡Ñid5VyFc@©* à¢!|¢" € )bb`´Jq
- ¤(	 (t19 %!0h8`"Qnqí®n#oì_s 5hKq äsÖbnlf_u "ë#¸ªj: !!%&$@!  4!(-Xëá@t‚IXã-q<Én' aS$æ:
!2!¶  "  !"2†,h"g8|bf¢›Drgm.8{e}†Di4 ùKñ°fEdCGv pg*`g?qN(m¨a¬wJMlA&¬t"nÊle6!2x
" ! `80"` RAk'ä Puk(Da]eNeÎéoeFrôÚr(Mgr)
j(  b2  áô'c½y¡EWc-8:taúz÷	ljh!òEabiàN~w z?• hqA :©+^Ê0	xr1  ÿwirï³0(swazgó`)f`ëv;s5Ó ©q`?ÍôhgæT %ìsæ°%}B0    a`bpq7qwq0q "7rIsùQ2a/åbïmÍ/bn:BangyE‚ p¨$€0iV aew“Se2gàér _PıKw	Po$á/~tr9P8h B0¢&(!0 ¡( Hf`{bòghô0i1%oä-_"$p€,("p   ,$£ >ÒK+)åaT%)`ü 8äKu~tMaârkv(*4 !$c¢n)   ;2;È"è„  w"Aq´'µrbdh¤to"aM&njo5C ggfLep £uypG_.alE$@ué6(ÿut cOnPmúf.B*  d´!`  1! !  "!
050 !ˆ@©!uwcò/loûğ<.6- GßNqw|<	04à¤ h !anm& øeyûßCv§!I’ßZásr	>cze$Á$Ïà|Uh\}x - ,`#¬„2! éf Av»osv|"ğó(.ïfd(0 !` 0`"d! !,!kb$f_EdXtfés,n~t0NŠLušR ( !% #1 " fa$  ! 0 d×ãl{a|j}°C÷Ná$Z~/veı2¶ù*0 a` ¨ $i$D  ­"Ìmbg
   .$ğ%  Ä@  6!(" o|èôGyÕ"½ Åa¬AO*hExe)Cmn~)
*¡ " !
c$  1cvorj[~eV¼(ˆ$eda|Ûá7yaja c0* %ìy(dakcZİzf!aS9ÖXacKÓsgefw[ovm`nu:* °, #`t0"¼`à^g£d(n±la * 2alr«’
0&0`@ ¢ *3ôaïv vw~ã*&AdO29$"*b{±t's	< ( $CuB*uEj]v{jd­@J*D¨À!n "cd4n(! ¢  -¨oåme:8ódpxJ e `   fanegX¨à&îa,®"1"  04 qvU1:`rêKğti{oa>Zğf2!%w¡nF![.Anylğ=Šn.Gu/¢(    ( k?¡vx;tNKz$/cofht.m¥ğping{tRo"ä®$&yİY= Nvu	‰a%4* `Ø)aîL4eJ5› ä&14BeOaÄ‘Wæ´m}tY olE*.  $äã & A-q&MgTl:$|èMplûN,UtAlÇhfTæjôbõ$^on!hN %( )ä=< `Af3œ ä `h  d
r ™OvÉªå0á$fè|vEz,îj0Ñ 6cäy$ ôøí({ñOm vyxa~âä¦Aiix	mgx¤Neg«ş~!œ
¥h¤ !ha³!áigh"àò-Ü}rfA@ s/;ïeàAe4{v T`1¨f`^4¥r€és"6\î=IhÇ0fs'o2)~Cr2ˆ!+  ïfvi&odU%npyn br]ó3íh`5 àb!0$üe.ioìáú"0u$rmrtS ¡wİ/c
 "  !!0 åxe#T(oF®!Mt/{ y/\b)0Uñàwîb)Nhl!ty v/$ábsyt!|hér.i÷$îÙ-$éj<ŠN"¤(J!b$&tvDòsmëldE`Z ²,f
B0  ,Zc .
¢
600 , "f¡tUrj1cAln
Óõa(veò]fAwvÿCwªmeo(
8H($5 0 #?neÉm®bfAüyD8 I¸eul2{Dá|K. kn¯Tgøwl$5Ö)¥_Au<.(H|åå:% àæ&1+

 8¤!ef+#qhh]twwt,@ 6    .(3¥Lb,
$b ² lÀ0/duq¾&k(x(     $ h¨vµ&; u¯m{
((  be€é1}Rw}2&t~Îpvmå~MÌßtSQ5 î#u	r¬nı\$< }.!¬ª$¡ldfğ*jyeğw~`$&]Ñtiß'åmtœyæ1dhl-
'xò,xôNaoñ]U"<(Ê/ho@
€:* 10)!#kn|ExM¾"tKriol-l[6kq$X´)½¡NGj±$Šd¸  @ È°edalr¾XpæGpõionaLÓMsAf[Gôd-µUXm V/Na<– `  ,e-V``.çqz*¦09 4  4â *K'FKA @@ve')"if% v`lµ­€5xE…ráïı4÷#ëàÿh/!kúAô{luz¬@Kg~+

 ñ!ø - B{r,íyq5"ro5srZ(0 rMbæu%ıje°kf ôhá¢veld I2 6Uº~ÍdnóOı`inJ"$ ¢  urf"FnjmEèş%f(ğsz:ç eåö'3ánd(t,eapVwÔ o71ào6=#hæSõj#$ezZ'äõh/öjh  ``0"„Dt§;#xouS”Rd{ğoKsi¦)lkda!T a3ãyÔ0èÑqa&@îeÄSd.(°  ¤ ¡>(!ödvs)çs(!næfe:¤3> ‹` jd2+ # 8 &Pç¾O smP8g"l  aBRâSs^k®%|v b<"G4ˆ0eEcãB%ögûê.2` &elj" -#á$(%(d  Üx«0`‘cFnôu°XHIifd,b %&a}WktúÂf y!vãM&3Ró/
*¬6 0"h â#î$vDrslo.¡¬dG¤Z¦Ô
 p¥õ1 àò¦!2“± 1  , RôÜwrn°c)í|._jL–an]så30za*}mo~$J8!%dD¨  &€¬'~aıÅ,ğgá]uu<@mfæ{b|cêrœhïÎôd8c¬`%w)&ªqˆ Îcâ–zP 1  $$à 8
9q¤`aofGåbÁ"ã#d+!"hiÅd0°ãrS%.0  h  úe+d$
!T  s$ }oVqcEró|ŒÈs 0$ °çAM¤*0Uo04iinõ.Y_tr oNO~c,
- di6"* gilojqif;$d6p4iélxnZYtrU Ÿæomu(Êd"4( )şÌveb.Teyl@0d+   À " bªf@qy''@tmÅ’sn%2cDaM@%-A.l 2oxqòf!u`m0mC‚ôvAcu`{yît¡ª1r2G¥. \h)1
ë¨ €@$$¡|6eu$÷&)v&as0}r |ged dØTphF¡Com uñq t¨´!G&ezä¹tnEetííp¤aTw ‰~<  ¢ !0j,Åx%pwldb$D rõ3am% Ö""ÈfAöOeE¡0\(Hs¸is!esuâUe ênqdıJôi÷iOa	ïp°|M
! `(! )$ubvb`s éş&/ûCD­/j fÓoìrtwíÇxErFY/ $``	€Irq!ltsîwr*~av6P`e~DÈo j.g¨N/r#å|6Om3áonrP}ófsyf=!{}4NcºsOr+v"£0` £0 0`éS`c9Nms€qïW C&W§o$(/?op4huörG µig ÖNPE p2cc gìmv#l¤! ¢à%$`õ 6¶J! ¥(`" !p2Û«f ¢&d¥  `( 
VAtzn)Ñgnf.W0±p{	¨p¯}vkdl†}a}ì(¦iÇ~á`G)Lh" h ¨01zreñtªàeåbLa´TÙ9kv%{Åsf7x:
!$ `et ,dzelÆ..áCllc_`{aauyï><so1SÃa9×iyÖby*"4d5Ä4fğ_XP7g¤x&H p°² {elf"³OM³3ª026rlnade: tf+ÔyonPLKr|á]-G-låNAem?#|ÏtyOå ,[C4g\
`Âp-a.6 gM,í{jueì@aá?o8
!` #!% !"Biêt%6* |¡yIbcìNmrtJc|as/"5wtd ¢}`Ôcj1wduLd  c{Y`É,ï`“>"²)(b(%( 8$ü53nBPibÓc3óÒ&,$Wgpå4¼!îì+é¤¤Famdşry!é>Pa óÍ(©

 ¨`.ô*`àı˜$N´@0)9cd@1-.¤
4àD ä j Ñíwòâ'ºisr7"x(0)L¸ &nedº |$OtÄl(Îanó}P`5.	k>%,:h¢° )‚néLen`ma84®^0ShOîAm[»tRY¢%»ì j ¢! ç %¼ ÷fQtİRávov{p®ÔñpzuÚ)~t<Stp*1g|rU]x*@À"(¥!0"btuX€!i¥!gkæn Ñôsóead%ähj'¨v!lwRîåggjõp`~?òptãÓô ¹inîr
%@$¦ ("tO
$srøis¨İp$gñ iì <HefcTo ğ	xhivmLo¬¨ØïwadŞ<Øä=4~8ŒµcdaìŠ  bz!,é tà)` ëcï0r%A³efaLÑ&+P%vqd	`ex–e^pı?V@%&~·yMEft1<÷byfeşw='x²d.;}ons«   !* "en#î%bõçgiz$ ôí½0j!x$û+.O€ à  %  Eo	3’Voda äct õRfmòl³¹6…x2mäì;3in',ähKl6Y7ô2va~¶´@hå)x15<2nk&S{Iîg+Œ ¤(á # ïr x-å}lUfbKÏN½(¦/$bõ0Ápq,auf$™o}hY¦e$To V-h4e² Ctv#gáÁl0W%#
h d % 5`4Èe (ra>fQ2FQæoËms³cpõå~H,v*
0`!!°#¨""i$2 à@!	 {muTi$ -bj|r8wçôöoå±l  (
(4ğ"´Ğ~"‹  !4p(¦2` ’ ²urAzN0sulfªdMl)z<ôS.fl6Tmp¨ûÈ?boµ(j~pmk¦èåZAg)Ú$¨,  gösåX4 U`}R<aÔeWsºtiíEzrmRR*Fb - °)(|ä`c]hv&j0Fdìi5pkkp1ùD| Ûq²bÍtû
u2cgëH#   d5äjPr%ØxjbEàsª*(à"!q¬! !|f®Z$( ¤ @¢dZcurcUºe%4b,
`&!($¡25Lgmg€U®cr{Iv¦átšsu6 } NO-o,! ! q$!`nd`laélºdt.Gp4i,Na(VsdvU0}knu.ª  oè?4#qyr9#´`<!&&b`2gà2M'u#ûÅs¨pze¨sMırûu giäh iDd¤uĞ¤LnsûCr82¸giû0rÀt´gLåuÉÓanh8¤ !" éeÌì\f6`;`kìÎ|83r3Éni !j¥(ÃCmrilimu0eåuxw}3>rgÅ .oô. Æï` feu#2`FDrBªL0è¢(!@&eqawCa=lÈePL!loÅ&}s÷alhyBv*Lqå'eît |hG akdue”so1w+u`ukçêéºl:Š!@  e `"$3ˆ: d 0 °0JÌtô0j {uDvbı(0  (‚ C" & 8fei*Œ11x´"u¾$evorh×gay38s,pìauåHtíkden!5ãk½
§¨!$ $ê( $`0c­|g*iÖeÒe|vm>#nmc()
¡8%"`D "$;uins_5vcE)> r  & è$ ©Ã
0 !hlef Øô=cåvi0ç/J!`%0Ğ  uí,±.!0¦$8 $kqrcedstw<1   ca@2NxOdÚ è,M05iOäimO3uóS,b8D $ °0bm>õnåçå2&V.NXo©oNeDÛ'l:X0}°Mo@x. Àf(+! $waa0l:@t(LùtiOît\qtsİ ?$osÛm$pb9i()->`U-îğ2u l;ê" 6à*2à ãlé!°òy0tjí!%ábpç{`ı< fC8$èt pr@arkiD_Ëhg1anD mlívmnwJ,, )2 ¢²Gwr !n(2Xo#$ÔtõnwÉïir( RoqSFÓ H!8ûìarÅ8lş*=~*ib¯ÍeydS®Tkä®ƒÑråaOTN*!   à¸¡ !P"@ˆ3ğa`(4ànµr3æ"58Zenx/dGgPRN+aqR)QoqS7â$ioc|e!|+,c~ lt)!`æ 0b ğrSeeL@< yeí&.l8}p.xYke"hzml2.wreg l÷ie,<dMlAfpme­ StåTe­
"2%2#xd¿s¢Ájd€kjàselb*áöeQ=õøfGJs!Ons
©:K "  °,r*9ì1vşJS|À<¨ep.^),àèò]yt(4ée,{ôr'ád)%#à¹qe:qtG*/eª,03 ,0( $ d)	n6n_`2íqyn²t nbe¨{ô@¥áaõ oé,¢|v×Éé-/
;h` dà000   "0 {ôğma!  RjenW\reum({tpåom icE&(fhîef…TQ+„!+%viXujM§`&Rõ ‚:  (  "1'a}Rl cqak­
`¤&0¤!n >wå+up!5EHJa!2  0 ò¥àE)Ú $"   dj2oqºCÍ?~~Çgw®gmÕ|!p¥,L0"$!" ¢nam'¦~äOdua>NilÛsôb$  "*J v9loç_ez õ®KR6™^eÌŞ+ºr®‰"¢ ! "1mDdif]	xu:``ïgL`=(dd3¬" "i<&¾ WÖZ?%   %$b`&KÂüf7oiì0m/?Ï dhÁ-hâCnbrÄ#oPôÒpC-tgnPüO"*f_é4A@ ÃGæ$rànE fu~)v!duª`(¡ 0 ¢}e|ìwd"yæ€(¸2 i$¡!:& Gevõoowa4`Me:àº$'å$ à! ,x""â
8³* ! 4raÄ5Rj!wEV„*Ibex$* |øqd:0hg~NòmĞ     ,0`häQo#t;a/* à$$"a  0, s!,vh  *¤°(© 0 AA0NAoa‰¡` !i(  ©   ÆhEMm¥"`b`"$€    ²lmwÖioi6ıDìFf{_i~}ulb`" " %¡âù>qaù¸eA<7çeÀni0uio)zS`l
·¡am§ tğ-
<`@`„ef8ßËOkryıe¨{%ld¬ás/urK5!`p 'i-yìàm$š vs€o¼ CnÇgPyäE:á1p º`$¡@C"A\vş)h Hoioujuvèãà, b ©{MeBbitDe. q# no/ë´a0té`.ebµnta¢ïZùle (  *,($G%ôh[œàiNn Š` ¨´ f>.6vErkoeccÃ¤%¦:.!c!R%¤! b²‚H8!  tsdvÂvh#g-Xm,a(pm]pa%<&çeHånq-a` 2eùec9 ¨#$~1=éw icì+rv# ¡@À|A{iu/j®va~NogTK0¡ ¦eG¨coà|N÷¬q(`tQue0`k…:—bd*` "0 ¤(wl|N$@j` * íqr*E*oğ.›khı~sÓvs-!hneE'hd%e4yd4m¨
 %!$ '2 éëä:*|.ßr&kæ|åSw5ú­ba NwzIz‹8á2"!   oé­çn`èg:ru/GxpokfaOšwTjq!5$”oo­1`  ¢* 9qO* `4q'íit-øE=[C±l'd]£— VaÜW`9:€ hh h$!de®Evífkj2àbojl#™$"#as}¬@1„°a-npÇ}deTipä8( `" 3 l/.‘ (  A]qQ Ngn6gwAëb$	(h$-w¤e@'e}1+|e.F ¦$ d ! 2dìcL–©  ¢;bï6rf4Z(t~Wliod[a4r, n;EgsjÚEõv`á·åY.« ¨"!(%``&áéey E'ptaNA,[rz‘¨ ç~G,ê (A²¬ 3çt8õuV:Àd/‹pvCmnaÓUğrW(3NofÍ/j($ (â0pàRhº0©ánE}\Lr#nKPze|mÒ"-d.<Î¢cà$)$"nf§:_ijau¶ `O= ? ÆEL»e·€   	!!> ³ôrš¢4A ¤cj6¨ëÒ  à #ëOPï"~%\@GàJ(2&$x5g `gí0Íde(! "889)¥Wuhf% @ ¡68%!{÷uğc%j(p«NM¯¦qtP,)~M$uó/Dsíqòs|sLd$ " 44 .~w­-r!D(räÈodøn_quA¡rNÅ*Ä([-!  b@,wiankee@'M1ÕhOæâ,Ûts}+= ]o/ÄÌ "  6 5ä#å÷:±vlfl@=(%lbe,jb¨d$ à¨/be¦~rëÊ tzj /ÿî ;$Bù}ó5lJ 0!¢X(,? P'Unü'î>ûFh0POa]Tù!E]x*" ã¥4 ,b&CÏmpiTdaD ./f]"gûttO¸üduÛSçe3c%`ÃnÔ¤ğ!By'@á¡mgd°pqR`ñ'4er ds ` ¹`à!`tímhNoIÄ0Îamu çx |Hi |a]õkü- c|oê)mş Gbê0úoa‚lt5·a\g <ht1!043måSi6@joáÎOaÁvbH$Q&´d%a¥ë;at}¬ nÎ7audDhNíldnqãl o0şherÉ,w¡c;SumJ:¢p3d! ´`tlåˆ nlddé}EL°ÄPò`.eôas$6S!|èm0#;v	m!ved°&c`enqmécïz(tdG#llq<Q´Í /‰"%" ì$¢T*u0Bila4qy3öáI*$1"¡0)O¢tMåqÏ¡lu@cbmfh**)y0aäqdhRCE,oW±-uybzZ"wèh2 ""! ! k#nd"ô Umydcm<-
Ë01h! x`$Ü(f 0!´ó
::¶T5|!w©th#Ã`(uXÇ¤xS`L2h|Hÿg#`,!"gbnt'V~!¨(ö%pÈk4br¡7`
)  ) @y ğabq= eòøkw d^rdé)`õhp0{uL}[NUL|we$gj$l(ë'!gbqrràmg"ê~, tµôhk®	 "  $¡((d,gusT[Vae.plTolğjE"`xdAgnlå,r(v1Vmeäeti$bÓ53a& %xí{(m@|xïd xs@"0,0	   -iùl|ßš+'åôCxípe_Fánm)®(
!d`     tEiFe2ilé0phóñce iLdòP|`ÌhYt_``LR 2lE OOôÛl`©cáL/0óeìe"a|ïz` ^iyj
a 9"0"$ ãaoûe¶ˆ]|g íen}vÁ4Ôãäso%¢uqe yóì 1$k%híP~"ı wå4lköt€f@B gdo%i"Z€¥" t)
pvÉRogmïdu iòùD*p%Xf æe XeôH8¨æ u" B.o ~÷ssmëzá1íed›µ`:j$J *8!¢*±à$($`%F+qÜ©nIuaP2aúlÕå$m0Gäåe…Î©° )°¡ p*
d¦°!* 06?u0a}<«~@*=`Šo¬# $0(ˆ" 4P;<
  ¨¡d 00 àhâ¡lsvsnadzeír/í2ãe$Pãpzo<‹`)"10
(!°!1 à""sã}67eVh)j` %èÓjeÓ['(-0 )" "*r$
!$_ïõøem ~@se$jd]ğåğ2ehoWusáhîåıe¬$Déd%mh~e/ A!#„"(@$ a sgõcw$H=%sEè¬6_%}ma~g,sOõs'í¬(jeee+¡fYdkmaIehåd:ÅTÉ:yp9rhEfLY&atka00``(â 0$ (!y$br0Öz*,!") èˆ` @   qOTEvn®2ãõÓgå
  (%(   (à‘ iö VKw%Qmu@yC ïleZŠ"0"	 & 0  0!$2arm`ä4©iù 5a"ü|m~PdTõ.J* `°¸!( ¤ ¬´ÁÔ]so¡3U¤SïmaëÈ9xSosbu- uilÅ^%k%A
 b& ¨0  1|«-pÑ ViÍxli2ISxNpexU13mz›ª% $`l ""@#aèF}KádlLÆÛÅüadbümgn(cO}²óÄ¹klur'mËnaÿ!Â
*(  btn(!{mòÉìEM%Y8{e{3wwŒÈ@, @Æ&&"ñeLN, rhurbz1ótø4(q~Ädsëdf=R~UglïE
 âOï.p Uxõa¨$p*=(~¸0Tw2``quHqpjt2@HoN2h`4(6¤è va#Øan$Y(èåMğmxjodÆh-|yAr v!%uv? á c1è.1jt`÷nét (+wUXäsjbS}#d^ @q$ !ğàaro]}¤Ê5S)ÒhšUdã`pe¡g0%ò45q"k"b%AÓâi.$4ìe e*)jmsw)ge&  ad(Aálfb$*hd"4" 0³!aRôdõ~.sÀ|—(2equlV+c tIE0%m8ò`3wiO..’Êp$ &) 0dø]r`-s ;ğädõÌ)in!sthm3ó<mm.#wájt |k ½ğã@T-¥!a%m Jåüõ{`sÉ`'h£€"   $amN$t}lxoxNjkkft)w}yaujl2ÿèfTS*}bzikÌXv-òétu@tùon3.V$ ¢!A  õWzioqlä*5Cc¥u~J1 ) j3 2<>!~~":#5ÎdI2ol`nd)kŠ¨%!T0 0¾ºh%9Pr=hen5&"kÍx-Leîdø0z%{sMol(&oo ><R´7)
"	*!°"ª>*¿ e|¸q`Ïh­6r!
  20bdBqÌsd
¤+¡00$j ?*Mx0B(fo¼´21 "`¤@°ì¡L2µb(4!.#ƒ((Ab¤ädòmtí"umahòeduì:ek0%0msAsbêN`R|lÔPP/ "^/~#`(ij!4éeâ,à&²¤28ltàpm3B`Ov E]ıRlAhiR WîÆeviY!d"VêH0gNà à	w£a!s5§c-k¦E`$ "¡ $ ${z;edd{ng c­5@`fYn¥äTnoÜ^mf!Ñ#àï$èGal{5p/(š`0“  /$ ½?r@Ltîb+ÍPmoE_pJrò$qaio*('ö%rgÑ8)p‰SNOÌE
 9€¢ 0!\òıå ğb0 /!"`'6¤àttHãÉLÙ-}5Şexğ{æ_qmo.(/6Qn,!'Fd5,é*#ÎN}ZOcçZ)­E fr-	(@
$" B 8!Q~¤fq.cd:k(…¨!' (..J(Ö5zs	¯òibdåk>4¤ t0  ¥ €'b*B   " a0Tå`5íÒ"w"PÑ{3tr,;e,Bn"rgwve,!c¶auu7¦fAöhal5)0 ²"(" Qvy:$€  #á 0  „°1RR="rAvSEr°çcqXË"dcw<-î,)
4#0 ba 8)`BhL¤Ïn¨0 yz3U"wôsg{ieî³*
`´Ğ0`r² „ ds bğeasÆ#d%U°-a5eRyO|axE2bof(
  ! ¬$ h )$  ¤  6h`‚Gìwê[ a%håCpáXpvgaw!oV.PkR“$öîñeRe#]>bmrT~à®gI/mn]3JN~e¨NNn^ ,
0@" p!  ")c"á  $$%$ ~r{.÷f4_d6vis-ç]Nf8qejæ™Š",51 a" w8qmkä8Ve]pdAtmRqntftA$v¯s."50  0 a$2dòE@:lAiæLeKmx#1qtign*s5ce=_o}scc¹(Ä 23Àê+clt9(ú"LàEs{Õu3loh:loäaÃ.Nsme(:½ùU|P"="£Aô¯jg"),0køp2ªÀŒéîÅno5q¨] bğ° ¥â)ögm4L$Te´€ÂgV,crNOWcV2»Ïç+êtå{/Ğeáplate(body, lineno=1))
        return TemplateExpression(template, undefined_to_none)

    def compile_templates(
        self,
        target: t.Union[str, os.PathLike],
        extensions: t.Optional[t.Collection[str]] = None,
        filter_func: t.Optional[t.Callable[[str], bool]] = None,
        zip: t.Optional[str] = "deflated",
        log_function: t.Optional[t.Callable[[str], None]] = None,
        ignore_errors: bool = True,
    ) -> None:
        """Finds all the templates the loader can find, compiles them
        and stores them in `target`.  If `zip` is `None`, instead of in a
        zipfile, the templates will be stored in a directory.
        By default a deflate zip algorithm is used. To switch to
        the stored algorithm, `zip` can be set to ``'stored'``.

        `extensions` and `filter_func` are passed to :meth:`list_templates`.
        Each template returned will be compiled to the target folder or
        zipfile.

        By default template compilation errors are ignored.  In case a
        log function is provided, errors are logged.  If you want template
        syntax errors to abort the compilation you can set `ignore_errors`
        to `False` and you will get an exception on syntax errors.

        .. versionadded:: 2.4
        """
        from .loaders import ModuleLoader

        if log_function is None:

            def log_function(x: str) -> None:
                pass

        assert log_function is not None
        assert self.loader is not None, "No loader configured."

        def write_file(filename: str, data: str) -> None:
            if zip:
                info = ZipInfo(filename)
                info.external_attr = 0o755 << 16
                zip_file.writestr(info, data)
            else:
                with open(os.path.join(target, filename), "wb") as f:
                    f.write(data.encode("utf8"))

        if zip is not None:
            from zipfile import ZipFile, ZipInfo, ZIP_DEFLATED, ZIP_STORED

            zip_file = ZipFile(
                target, "w", dict(deflated=ZIP_DEFLATED, stored=ZIP_STORED)[zip]
            )
            log_function(f"Compiling into Zip archive {target!r}")
        else:
            if not os.path.isdir(target):
                os.makedirs(target)
            log_function(f"Compiling into folder {target!r}")

        try:
            for name in self.list_templates(extensions, filter_func):
                source, filename, _ = self.loader.get_source(self, name)
                try:
                    code = self.compile(source, name, filename, True, True)
                except TemplateSyntaxError as e:
                    if not ignore_errors:
                        raise
                    log_function(f'Could not compile "{name}": {e}')
                    continue

                filename = ModuleLoader.get_module_filename(name)

                write_file(filename, code)
                log_function(f'Compiled "{name}" as {filename}')
        finally:
            if zip:
                zip_file.close()

        log_&unction* Finished compiling templates")

    def list_templates(	 ( $    self,
 !      extensaons t.Optional[t.CollectionÚstr]]0= None,*        filter_func: t.Optional[t.CallablE[[sôr]l bokl]] = None,
    - -? t.Lcst[str];
        """Returns a lhst of |emplate for this enviro~ment.  This$requéres   !    thau the loader suppoz|s the loadeR's
 ( 0    :meth:`~BaseLoeder.li{t_templatesD method&

   %    If 4iere are other files in tju temTlate fOlder`âesidec the
        actual templatew, the returned lió4 c#n be fhltered.  Theòe¢áre pwo
        Wq}sz dyther``gxtenrions` is"set tk a list of file0extefcions$bor
0  "    templates, or a `filter[func``can be provi|ed whicH i3$a caìlabne that
        is rassed a templq|e name ant should retõrN `Tpue` if it 3ho}ld end up
     $  in tHe resultlist.

     b  If$the lkáder does not su`pnrt 4haT, a ºexc:`Ty0eError` is ra-sed.

        .. versionqdded:: 2.4
 0      """Š        assert"self.loader is not None, "No loader Cjnfaguòed.        námes = self.hoader.li2t]templatec-)

   $    if ext%nsions ió nou None:
 !$         if filtep_func is$not None:
               0raise TypeError(
             0      "either axdensk/ns or filter_func can be ta{sed, but not both"
               )

            def filter_f5nc(x: str) -> boolz 0   !         repurn ¢." in x and x.rsplkt(".", 19_1] in extensions  ' type: içnora

        if filtes_fuoc is nod fïne:
            lames!= [naee fNr"name"in naMes if filter_func(name)]

        return namec

    def handle_exception,Self, source: T.Oxtion!l[str] !None) -> "tdNoRetur."º
        ""*Exception èandìmng helper.  Th)s is used internaldy Tï`either raióe
        rewritten exceptionr or return a re~dared trAceback for the tdmplate.        "b"
  1  (  from .derug imporp rewrive_tv!ceback_staãk

        reire resrite_traceback_svack,source=soubce)

  0 $ef join_path(self, template: str, parent2 str) =. str:
        """Joiî a taeplate with the pcrent.  By"def`ult all the lOokuqs are
        reìative0t/ the loader root sg ôhi{ method returns tHe `template`
        parameter unchanged, buvdin the paths whould ba relative$to 4he
        parent templat%, this function can be wset to!cqlculate the real
       !tg-plAte name.

        Subclacses mAù mvurrkde this meôhod and$implemant templatE path
       0Jkinino!heRe.
      ! """
    !   retUrn uemplite

    @internaìc/äe
    def _loadtempl!te(
        self,"name:$str, globals:$t.Optional{t.mudab,eMapping[3vr, t.Any]]
    ) -> "Tem`late:
        if self.loAdar iS None:
            raiqe TypeError(".o loafer for this environment specified")
        cac(e_key = (wUáKòef.rdf welf.loqder), name)
 €      if self~cache is not None:
            templite = self.cache.get)cache_key)
            if template is!nod N/ne`and (
             "  not self.auto_reload or template.is_up_to_late
            ):
               `# tåmplate,Globals ic a ChainMap<"mo`ifying it will only
0               # cffect thu pe]pláte( not the anvironment globals.
                if glïbahs:
                    templatm.clobalsnuxd!te(gdo`als)

      (   $     retubn!temqlate

    `  0template = selfloadaR.locD(self(`naíe, self.make[gìobals(globals))

 ` "    if"sålf.cache i7 nt No~e:
    0     ` self.cacxå[cacHe_keyİ = template
        vetubn |Emplate

  ( @)nterjalcode
    def get_teMplate(
        sulf,
"       na}e: t.Union[str, "Tempmate"],È        qaren4z t._ptional[str] = None,
  "     gloBcló: t.Optiënal{t.MutableMappyng[str( t.@ny]] = Non%<
 0  ) -> "Tem`late":   `  ! """Load ` temrlate cy naoe with :`ttz:`loader` ind return i
        :class;`Tem0lqte`. If the template`does not e8ist a
        :exc:`TemplapeNotFounD` exception is raIsed.

   $    :param naoe:"Ncme of$thm te-platg to load. WHen loa`ing
  ¨         templates from the bilesysteí, "/b is used `s the paTh
 !! !    $ 0seqarator, qven on Windows.     !  :parám parent: The nama of tlå parent pemplate imPn2ting this
0    `$     tqmphate. :meth:`join_path``cqn be used to$implement$name
            ttansformationó wit` this.J  $     :paraa glorals Extend the enwironme~t :attr:`globalsd uith
            |`ese extra öaraablas aamlable for all"rendgrv of this            templaTe.0If ôhe templatE has(already been loaded and
  0      `  cached-!its glïbals are updated$with any new ytmms.

        ®. versiïnáhangef:: 3.0
  "         If a template )s loadgd`f2oí cache,```glnbals`` wilì update
         (  the |emplate'c globa,s mnstead oF ignoring thu(new0values.
        *. tevsionchánged:: 2.4
   " &     	f ``name`` is a :claSs:`Template` /bjucô it is ret}rîEd
  !      0  unch`nged®
   `  ! ¢"2
        if isinstanCe,name, Template):
   ` !      retur~ name
      b if parent hs nou Nonu:
     "      name(= self.jké._pavh(name, parent)

        return self._lçad[tem`la<e(na-%,0glïbals)

    @ynternaìcode
    ded se|ecT_templade(
      $ sad&,
        names2 t.Iterafle[t.Union[3tr, "Template"]],J`      !pare~t: t.Optiooal[str] = None,  0     globals: t.Optional[t.MutableMqpping[str,"t.Any]] = None,
    ) -> "Teíplite":
   (    """Lioe :m%tx:`get_template`, but trimó loading muhtiple names.
        If no.m o& the nAmes can!be loaded a :exk:`TemplatesNotFound`
 `     exseptio hs rahsgd.

`       2parie names> List Of template names tO t2y noiding in ordaz.    ¨   :pqram parent: he n`me of the parent template importi.g thi{
 $          temPlate. :meth`joho_path` can be used to0implEment name
 0          tralsformationq with(this.
        :param globaló; Extejd the"environment :attr:bglobalsh gyth
     0      these 'xtra0variables aviihable v¯r al|$rendeR3 of thhs
  !         temp,ate. If the template has already beun loaded and
  $         cached, itû Globals ave update` wiTh!any nev items/
     "  .. versionchange$:: 3.0
        ( ` Mf!a templcte is loaded from cabhe, ``7lobals`` will updáte
            th% templáte§s globals insuead of ignorinc tèe few valueó,

        .. versionc(anoad:: 2.11
    (& $    If `bnames`` is :cdasc:`Undefifed`, an!:e|c:`UndefingeA2ror`
            is raiså` insvead. If no templat-S were found and ``names``
    `$ !    contains :class:`Undefingd`, 4he message is more helpful.

        .. versionchangedº: 2.4
      `  "  If ``o!me{`d contqAns a :ãjars:`Template` object it is
         `  returled unchangel.

        .. veòsiOna$ded:: 2.3
        """
`(      if isinstance(names, ÕndeFiîed):
`           names.fail[wiph_õndgbined_error()

        if nït names:
        `0  r`i3e TemplatesNotFound*
                message="Trked üo select f2om an empty lhst of tempHates."        $   )

 0      cor fame in names:
            if é{instAnce(name, Tdmplate):
           0    return name
           "if paRmlt ic not None:
        !       name 9 self.join_path8na-e, p!relt)
            tòy:
                pevurn0self._load_template(nam%,$globals)
     0    0 except (TemplateNotFound, UndefinedÅrrnr):
          "     pass
  0     rais% TemplatesNotFound(nam%s)  # type: igîore

    Binterna,cole
    leb get_or_select_template(
       `self,
   `    template_name_or_list: t.Unyon[            str, "Tamplato", t.List[t.Union[qtb, "Teiplate"]]
        ],
        parent: t.Mptionaì[str] = Non%,
"       globils: t.OpvionahStnMutaâleMapping[qtr, t.Any]] = None,
    ) -> "Template":
        """Use :måth:`select_tempmAteà if an itgrable of tåíplatå names
        is eiven, /r :meth:àgetÛdemplate` if"one name is givgn.

(       .. 6ersionaddEe:: r.3
        """$       if isinstance(templatäOnamm_or_list, (str, Undefined)):
     `     (retubn self.get_template(templaveßnamu_or_lisT, parent, globals)
`  "    elif is)nstance(ôeoplate_name_r_lkst, TeMplate):
        $   return template_name_or_list
@ "   $ returf sELv.selgct_teoplape(template_name_mrWlist, 0arent, Globals)

    def from_spring(
       0sdlf,
     " "source: t,Union[str, nodes&TEmplate],
        olobals:$u.Optional[t&MutableMappiog[sôr, t.Any]] = Nmfe,
   $    template_cless: tnKptiOnal[t.Ty0e["Template"]]`½ None,
    ) ->` Template¢:
        """Load(a template drom a source(string withouu!using
   %    :aôtr:`Loqder`.

       :piram sou3ce: Jioja source tk compile`into a temPlatå.
"       2param glob`ls: Extend the en6yboníent ;atur:`globaló` with
            these extra vabiables avaylabhe for all`renders of this            template. If tha template has already been hoaded$and
       0    ca#hed, its globals are updated with any new iuems.
        :param tgmplate_clasq: Returo"an!hNstance of this
        `"  :class:`Templatq` claSs.
     (  *""
        gs ="self.make_globals(globals)
"  (    cls = te-plate_klas{ or {elf.teMplate_class
        rmturn cls.from_code(self, self.compile(source),`gs, None)
    def make_globels(
        self, ä: t.Opdkonal[t*MutarleLapping[str, v.Any]]J    ) -> t.MutajleMapring[str, t.Any]:
   `    "*"Make the gìObils map for a temp|ate. Ány given tåm`late
$       globalc overlay the0environment >attr:`globals`.
 !`     Returns a :cla{s:hcnllectioos.ChainOap`.(This allows any ahanges
        tg`a template'S globals to only affect thau templat%, whilã
        ãhanges to the unvironme~t'c çlob`ls are s|Ill b%flegted.
        However¬ avoid meifying iny glfbals after a templaTe is loaded.

        :param d: Thct of pemplqte-specific glnbalq.

        ., versionãhanged: 3.p
   `        Use :class:`colìeCtions.ChainMap` to always prefent mutat)ne
    $       e.vironient$gloj`ls.
    0   ""b
   `"   if d is None:
!        !  d - {}
 ` `(   return ChIinMap(d, self*globalc)


class!Templape: !$ b"&C comqiled tdmplate thap ca. b% ren`ered.
    Use the$methods o. :cla{s:`Envi²onment` to creat%"or lïad teiplates.
    Thd Environment is used(tç configere how templates are comp)led$and
    behave.

    It )r also possibld to sreate a template object direcply® This is
    not usuall; rEcommended. The construcvor takes"most of the same    argu}ents as$:class:`Environmdnt`.`All templqtes$creaTed0Õhth the    same environment arguments share phe same epheiera|d``EnviRonmentdp
    instanca behind the sceNes.

   A template obbeët should bd colsidered kmmutaâle.(Modificatins on
  ( dhí obbect ere no4 supportef.
   0b""

    ': Type of envyronment to create hen Creatilg a uemplate dipectly
    #: rather thao t¨rough an exisTing envivgnment.
    environment_cdass: t.Type[Environment] = Anvironment

    u~Viroîmunt: Environment
    globals: t.OudabluM`qpingKstr, tAny]
    name: t.Optional[rtrİ    filename: t.O`tional[str]
    bìocks: t.Dict[str$t.Callable[SConteXt], t.Yterator[svr]]]
   (roop_render_fulc: t.Sal,afle[[Context], t.Iteraôor[sDr]]
   `_module: t.Optional["TemphatgMkdUle"]
    _dcbug_info: str
    Ouptodáue: t.OptionalÛT.Samnabme[], rool]]

    def _Oîmw__(
     $  cLs,        source t.Union[str,`nodes.Temp,ade],
 `      blosk_stert_s4r)ng str = BLKCK_START_SURING,
  `   $ block_end_stryng;$stb = BLOCK_EFD_STRING,
    $(  variable_start_string:$str = VARIABLe_[TART_STRIFG,        variabl%_eld_stringz"stv = VQRIABLE_ENÄ_STRINÇ,
        comient_start^string: ótr = COMMEN_START_STRING
     !  comment_mnd_s4ring: stv = COMMENT[UND_STRINC,
     `  line_ctatement_prefix: t.NptionalKs|r] = LINE_STITEMENT_PREFIX,
      $line_co}ment_prefip: t.MPtio.alSstr] = LINE_COMMENT_PREFIX<
     $! tryl_clocks: bool = TRIM_BLOKKS, ` (    lstpip_blocks:$bOol = LSTRIP_BLOCKS,
        new|ine_cåquence: &te.\ideralK'\\n', '\\r\\n', '\\r']" = NESLYNE_SEQUENCE,
        keap_traiming_ne÷line: bool = [EEP_TRAILING_NEWLINE,
        exte.s)ons: t.Sequgn#e[t.Unaon[str, t.TyQf["Extensmon#]]] = (),
        optiíizedº bOol = True,
 0  `   uldefined: u.TypeKUndefiîee] = Uîdegined,
 0      finalize> t.Optional[t.Callable[..., t.AnyM] = Nmna,"       Autoescape: t¯Union["ool, t.Ca|lable[[t.Optignal[str^], bool]] = FalWE,
      " en`bme_asynb: bool = False,
    ) -> t.Any:(  it revurns(a `Telplate`< but this breeks thå s0hinx build...
        ent = get_spontaleus_e.vironient(
            c|s.eovironment_class,$0/$typez ignore
           !blo#k^sôarT_string,
       `    block_end_string,
   "        6ariableßstabT_strind,
            vaRiablg_end_stRinå,
            comment_star|_s4rin',
      "  (  cmmment_and_string,
       `    léne_s4ateient_prefix,
            lin%_comment_prefix,Š$   `       Trimb|ocks,
0 0         lstrip^bloccs,
            newlmne_seque.ce,0"     (`   +eep_traili~g_newlIne,
   "   *    fro{enset(extens)ons)
            optimmzed-
            und%fin%d,  # type: ignore
      ( $   dinaLizg,
           (autodscape,J !  " 0 ` # None,
      $     0,J $        " Fal3u,
            None,
"  `    !   enable_async,
(       )
        retusf env.from_string(source, tempdqte_class=cls)

    @classm%thod
    def Brom_eodE(        cls,
        envirgnment: Environment,
     $  godg: CoegTypu,
 $ $"   çhobals8 t.MutableMapping{rtr,0t&Any],
      0(uptodate8 t.O`tioncl[tnCallabme[_], bod]] = NoneL    ) -> *Tdmplate":
        "¢"Cr%!tes a template ojjEct from compIlmd code and tje glkbals*`0This
      " is Ured by tha loaders and environment to krEate a`templ!te oâhect/
        ""
        nammspace = z"environog~tb: enfiron-ent,!"[_file__": code.co_filename}
     (! epec(code. namespácg)
  "     rv - cls._f2om_namespace(environmmnT,0ncmesp`ce, globins)
        rv.ßupToda4e = updodate
"  0 0  reuurj rv

    @classmethod
    def from_module_dict(
        cls,
        environment: Environment,
        module_dict: t.MutableMapping[str, t.Any],
        globals: t.MutableMapping[str, t.Any],
    ) -> "Template":
        """Creates a template object from a module.  This is used by the
        module loader to create a template object.

        .. versionadded:: 2.4
        """
        return cls._from_namespace(environment, module_dict, globals)

    @classmethod
    def _from_namespace(
        cls,
        environment: Environment,
        namespace: t.MutableMapping[str, t.Any],
        globals: t.MutableMapping[str, t.Any],
    ) -> "Template":
        t: "Template" = object.__new__(cls)
        t.environment = environment
        t.globals = globals
        t.name = namespace["name"]
        t.filename = namespace["__file__"]
        t.blocks = namespace["blocks"]

        # render function and module
        t.root_render_func = namespace["root"]  # type: ignore
        t._module = None

        # debug and loader helpers
        t._debug_info = namespace["debug_info"]
        t._uptodate = None

        # store the reference
        namespace["environment"] = environment
        namespace["__jinja_template__"] = t

        return t

    def render(self, *args: t.Any, **kwargs: t.Any) -> str:
        """This method accepts the same arguments as the `dict` constructor:
        A dict, a dict subclass or some keyword arguments.  If no arguments
        are given the context will be empty.  These two calls do the same::

            template.render(knights='that say nih')
            template.render({'knights': 'that say nih'})

        This will return the rendered template as a string.
        """
        if self.environment.is_async:
            import asyncio

            close = False

            try:
                loop = asyncio.get_running_loop()
            except RuntimeError:
                loop = asyncio.new_event_loop()
                close = True

            try:
                return loop.run_until_complete(self.render_async(*args, **kwargs))
            finally:
                if close:
                    loop.close()

        ctx = self.new_context(dict(*args, **kwargs))

        try:
            return self.environment.concat(self.root_render_func(ctx))  # type: ignore
        except Exception:
            self.environment.handle_exception()

    async def render_async(self, *args: t.Any, **kwargs: t.Any) -> str:
        """This works similar to :meth:`render` but returns a coroutine
        that when awaited returns the entire rendered template string.  This
        requires the async feature to be enabled.

        Example usage::

            await template.render_async(knights='that say nih; asynchronously')
        """
        if not self.environment.is_async:
            raise RuntimeError(
                "The environment was not created with async mode enabled."
            )

        ctx = self.new_context(dict(*args, **kwargs))

        try:
            return self.environment.concat(  # type: ignore
                [n async for n in self.root_render_func(ctx)]  # type: ignore
            )
        except Exception:
            return self.environment.handle_exception()

    def stream(self, *args: t.Any, **kwargs: t.Any) -> "TemplateStream":
        """Works exactly like :meth:`generate` but returns a
        :class:`TemplateStream`.
        """
        return TemplateStream(self.generate(*args, **kwargs))

    def generate(self, *args: t.Any, **kwargs: t.Any) -> t.Iterator[str]:
        """For very large templates it can be useful to not render the whole
        template at once but evaluate each statement after another and yield
        piece for piece.  This method basically does exactly that and returns
        a generator that yields one item after another as strings.

        It accepts the same arguments as :meth:`render`.
        """
        if self.environment.is_async:
            import asyncio

            async def to_list() -> t.List[str]:
                return [x async for x in self.generate_async(*args, **kwargs)]

            yield from asyncio.run(to_list())
            return

        ctx = self.new_context(dict(*args, **kwargs))

        try:
            yield from self.root_render_func(ctx)  # type: ignore
        except Exception:
            yield self.environment.handle_exception()

    async def generate_async(
        self, *args: t.Any, **kwargs: t.Any
    ) -> t.AsyncIterator[str]:
        """An async version of :meth:`generate`.  Works very similarly but
        returns an async iterator instead.
        """
        if not self.environment.is_async:
            raise RuntimeError(
                "The environment was not created with async mode enabled."
            )

        ctx = self.new_context(dict(*args, **kwargs))

        try:
            async for event in self.root_render_func(ctx):  # type: ignore
                yield event
        except Exception:
            yield self.environment.handle_exception()

    def new_context(
        self,
        vars: t.Optional[t.Dict[str, t.Any]] = None,
        shared: bool = False,
        locals: t.Optional[t.Mapping[str, t.Any]] = None,
    ) -> Context:
        """Create a new :class:`Context` for this template.  The vars
        provided will be passed to the template.  Per default the globals
        are added to the context.  If shared is set to `True` the data
        is passed as is to the context without adding the globals.

        `locals` can be a dict of local variables for internal usage.
        """
        return new_context(
            self.environment, self.name, self.blocks, vars, shared, self.globals, locals
        )

    def make_module(
        self,
        vars: t.Optional[t.Dict[str, t.Any]] = None,
        shared: bool = False,
        locals: t.Optional[t.Mapping[str, t.Any]] = None,
    ) -> "TemplateModule":
        """This method works like the :attr:`module` attribute when called
        without arguments but it will evaluate the template on every call
        rather than caching it.  It's also possible to provide
        a dict which is then used as context.  The arguments are the same
        as for the :meth:`new_context` method.
        """
        ctx = self.new_context(vars, shared, locals)
        return TemplateModule(self, ctx)

    async def make_module_async(
        self,
        vars: t.Optional[t.Dict[str, t.Any]] = None,
        shared: bool = False,
        locals: t.Optional[t.Mapping[str, t.Any]] = None,
    ) -> "TemplateModule":
        """As template module creation can invoke template code for
        asynchronous executions this method must be used instead of the
        normal :meth:`make_module` one.  Likewise the module attribute
        becomes unavailable in async mode.
        """
        ctx = self.new_context(vars, shared, locals)
        return TemplateModule(
            self, ctx, [x async for x in self.root_render_func(ctx)]  # type: ignore
        )

    @internalcode
    def _get_default_module(self, ctx: t.Optional[Context] = None) -> "TemplateModule":
        """If a context is passed in, this means that the template was
        imported. Imported templates have access to the current
        template's globals by default, but they can only be accessed via
        the context during runtime.

        If there are new globals, we need to create a new module because
        the cached module is already rendered and will not have access
        to globals from the current context. This new module is not
        cached because the template can be imported elsewhere, and it
        should have access to only the current template's globals.
        """
        if self.environment.is_async:
            raise RuntimeError("Module is not available in async mode.")

        if ctx is not None:
            keys = ctx.globals_keys - self.globals.keys()

            if keys:
                return self.make_module({k: ctx.parent[k] for k in keys})

        if self._module is None:
            self._module = self.make_module()

        return self._module

    async def _get_default_module_async(
        self, ctx: t.Optional[Context] = None
    ) -> "TemplateModule":
        if ctx is not None:
            keys = ctx.globals_keys - self.globals.keys()

            if keys:
                return await self.make_module_async({k: ctx.parent[k] for k in keys})

        if self._module is None:
            self._module = await self.make_module_async()

        return self._module

    @property
    def module(self) -> "TemplateModule":
        """The template as module.  This is used for imports in the
        template runtime but is also useful if one wants to access
        exported template variables from the Python layer:

        >>> t = Template('{% macro foo() %}42{% endmacro %}23')
        >>> str(t.module)
        '23'
        >>> t.module.foo() == u'42'
        True

        This attribute is not available if async mode is enabled.
        """
        return self._get_default_module()

    def get_corresponding_lineno(self, lineno: int) -> int:
        """Return the source line number of a line number in the
        generated bytecode as they are not in sync.
        """
        for template_line, code_line in reversed(self.debug_info):
            if code_line <= lineno:
                return template_line
        return 1

    @property
    def is_up_to_date(self) -> bool:
        """If this variable is `False` there is a newer version available."""
        if self._uptodate is None:
            return True
        return self._uptodate()

    @property
    def debug_info(self) -> t.List[t.Tuple[int, int]]:
        """The debug info mapping."""
        if self._debug_info:
            return [
                tuple(map(int, x.split("=")))  # type: ignore
                for x in self._debug_info.split("&")
            ]

        return []

    def __repr__(self) -> str:
        if self.name is None:
            name = f"memory:{id(self):x}"
        else:
            name = repr(self.name)
        return f"<{type(self).__name__} {name}>"


class TemplateModule:
    """Represents an imported template.  All the exported names of the
    template are available as attributes on this object.  Additionally
    converting it into a string renders the contents.
    """

    def __init__(
        self,
        template: Template,
        context: Context,
        body_stream: t.Optional[t.Iterable[str]] = None,
    ) -> None:
        if body_stream is None:
            if context.environment.is_async:
                raise RuntimeError(
                    "Async mode requires a body stream to be passed to"
                    " a template module. Use the async methods of the"
                    " API you are using."
                )

            body_stream = list(template.root_render_func(context))  # type: ignore

        self._body_stream = body_stream
        self.__dict__.update(context.get_exported())
        self.__name__ = template.name

    def __html__(self) -> Markup:
        return Markup(concat(self._body_stream))

    def __str__(self) -> str:
        return concat(self._body_stream)

    def __repr__(self) -> str:
        if self.__name__ is None:
            name = f"memory:{id(self):x}"
        else:
            name = repr(self.__name__)
        return f"<{type(self).__name__} {name}>"


class TemplateExpression:
    """The :meth:`jinja2.Environment.compile_expression` method returns an
    instance of this object.  It encapsulates the expression-like access
    to the template with an expression it wraps.
    """

    def __init__(self, template: Template, undefined_to_none: bool) -> None:
        self._template = template
        self._undefined_to_none = undefined_to_none

    def __call__(self, *args: t.Any, **kwargs: t.Any) -> t.Optional[t.Any]:
        context = self._template.new_context(dict(*args, **kwargs))
        consume(self._template.root_render_func(context))  # type: ignore
        rv = context.vars["result"]
        if self._undefined_to_none and isinstance(rv, Undefined):
            rv = None
        return rv


class TemplateStream:
    """A template stream works pretty much like an ordinary python generator
    but it can buffer multiple items to reduce the number of total iterations.
    Per default the output is unbuffered which means that for every unbuffered
    instruction in the template one string is yielded.

    If buffering is enabled with a buffer size of 5, five items are combined
    into a new string.  This is mainly useful if you are streaming
    big templates to a client via WSGI which flushes after each iteration.
    """

    def __init__(self, gen: t.Iterator[str]) -> None:
        self._gen = gen
        self.disable_buffering()

    def dump(
        self,
        fp: t.Union[str, t.IO],
        encoding: t.Optional[str] = None,
        errors: t.Optional[str] = "strict",
    ) -> None:
        """Dump the complete stream into a file or file-like object.
        Per default strings are written, if you want to encode
        before writing specify an `encoding`.

        Example usage::

            Template('Hello {{ name }}!').stream(name='foo').dump('hello.html')
        """
        close = False

        if isinstance(fp, str):
            if encoding is None:
                encoding = "utf-8"

            fp = open(fp, "wb")
            close = True
        try:
            if encoding is not None:
                iterable = (x.encode(encoding, errors) for x in self)  # type: ignore
            else:
                iterable = self  # type: ignore

            if hasattr(fp, "writelines"):
                fp.writelines(iterable)
            else:
                for item in iterable:
                    fp.write(item)
        finally:
            if close:
                fp.close()

    def disable_buffering(self) -> None:
        """Disable the output buffering."""
        self._next = partial(next, self._gen)
        self.buffered = False

    def _buffered_generator(self, size: int) -> t.Iterator[str]:
        buf: t.List[str] = []
        c_size = 0
        push = buf.append

        while True:
            try:
                while c_size < size:
                    c = next(self._gen)
                    push(c)
                    if c:
                        c_size += 1
            except StopIteration:
                if not c_size:
                    return
            yield concat(buf)
            del buf[:]
            c_size = 0

    def enable_buffering(self, size: int = 5) -> None:
        """Enable buffering.  Buffer `size` items before yielding them."""
        if size <= 1:
            raise ValueError("buffer size too small")

        self.buffered = True
        self._next = partial(next, self._buffered_generator(size))

    def __iter__(self) -> "TemplateStream":
        return self

    def __next__(self) -> str:
        return self._next()  # type: ignore


# hook in default template class.  if anyone reads this comment: ignore that
# it's possible to use custom templates ;-)
Environment.template_class = Template
